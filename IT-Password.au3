;~ #AutoIt3Wrapper_UseUPX=n
;~ #pragma compile(UPX, False)

#Region ### START Koda GUI section ### Form=
Opt("TrayMenuMode", 3)
$Form_pass = GUICreate("Form_pass", 298, 120, -1, -1, BitOR($WS_SYSMENU,$WS_POPUP, $WS_Border))
GUISetBkColor(0xFFFFFF)
	$Pic = GUICtrlCreatePic("", 190, 0, 100, 33)
	$hInstance = _WinAPI_GetModuleHandle(0)
	$hBitmap = _WinAPI_LoadBitmap($hInstance, 200)
	_SetHImage($Pic, $hBitmap)
	_WinAPI_DeleteObject($hBitmap)
GUICtrlSetState(-1, $GUI_DISABLE)

$Input_pass = GUICtrlCreateInput("", 8, 32, 281, 21, BitOR($GUI_SS_DEFAULT_INPUT,$ES_PASSWORD))
$check_show_pass = GUICtrlCreateCheckbox("Отображать пароль", 8, 56, 145, 25)
GUICtrlSetFont(-1, 8, 400, 0, "Arial")
$but_continue = GUICtrlCreateButton("Продолжить", 152, 88, 139, 25, BitOR($BS_DEFPUSHBUTTON,$BS_PUSHLIKE))
GUICtrlSetFont(-1, 10, 400, 0, "Arial")
GUICtrlSetBkColor(-1, 0xf85252)
$but_cancel = GUICtrlCreateButton("Отмена", 8, 88, 139, 25)
GUICtrlSetFont(-1, 10, 400, 0, "Arial")
GUICtrlSetBkColor(-1, 0xf85252)
$label_input_pass = GUICtrlCreateLabel("Введите пароль", 8, 8, 100, 20)
GUICtrlSetFont(-1, 10, 400, 0, "Arial")

Local $idExit = TrayCreateItem("Выйти")
TraySetState($TRAY_ICONSTATE_SHOW) ; Show the tray menu.

GUISetState(@SW_SHOW)
#EndRegion ### END Koda GUI section ###

; Главное меню
Local $sPass = "BFFE59BE546EBAF58E67D2C504D06925F5368F3F916F7FEDD23C8AD87F68A0BAF54D948671CC04F8451452505EC8AB558A172824128CB8880553D16857DE9BFC54DFFC4A76B252BCFB96AC114B0BFB55C31CC0E190A155B25CE39BB11F746C39D2050627C6EE6A2D8ED6C6B1A2D006A2393B5E081C44118765CFEA5DDE0FA7D1B69D457420979985892CA9D67DEFFDF0A5650008741B369BF02D7386B43658F49F2B38EA99D926CC027F7FAD639B43C259B8EFE19772FBB395A659A7BFEE77FC"
Local $sPass_0 = "BFFE59BE546EBAF58E60D2B004D01751F5368F3F916F7FEDD23C8ADB7F68A7B8F54D948671CC0486451452505EC8AB2F8A172824128CB888052DD16657D99BFA54DFFC4A76B52CBBFB96AC114B0B8525C31CC0E190A152C75CE39BB11F746C3ED2050627C6EE6A2D8ED6C6B1A2D078A3393B5E081C44118765CFEA5DDE0FA7D3B69D457420979985892CA9D17DEFFDF0A5650008741B369BF02D7387B43658F79F2B38EA99D926C9027F7FAD639B42B359B8EFE19772FAC095A659A7BFEF70FD"
Local $sPass_1 = "BFFE59BE546EBAF68E67D2C504D06925F5368F3F916F7FEDD23C8ADB7F68A7B8F54D948671CC04864514522E5ECBAB2F8A172824128CB888052DD16657D99BFA54DFFC4A76B52CBBFB96AC114B0BFB55C31CC0E190A152C75CE39BB11F746C3ED2050627C6EE6A2A8ED6C6B0A2D078A3393B5E081C44118765CFEA5DDE0FA7D3B69D457420979985892CA9D67A9EFDF0A5650008741B369BF02D7387B43658F79F2B38EA99D926C9027F7FAD639C42C359B8EFE19772FAC095A659A7BFEF70FD"
Local $sPass_2 = "BFFE59BE546EBAF58E67D2C504D01751F5368F3F916F7FEDD23C8AD87F68A0BAF54D948671CC04F84514522E5ECBAB558A172824128CB8880553D16857DE9BFC54DFFC4A76B252BCFB96AC114B0B8521C31CC0E190A155B25CE39BB11F746C39D2050627C6EE6A2D8ED6C6B0A2D006A9393B5E081C44118765CFEA5DDE0FA7D1B1E8400A20969982892CA9D67A9EFDF0A5650008741B369BF02D7386B43658F49F2B38EA99D926C9027F7FAA639C42C259B8EFE19772FBB395A659A7BFEE77FC"
Local $sPass_3 = "BFFE59BE546EBAF58E60D2B004D06926F5368F3F916F7FEDD23C8ADB7F68A7BBF54D948671CC0486451452505EC8AB2F8A172824128CB8880553D16857DE9BF954DFFC4A76B52CBBFB96AC114B0B8520C31CC0E190A155B25CE39BB11F746B4DD2050627C6EE6A2D8ED6C6B1A2D078A3393B5E081C44118765CFEA5DDE0FD9A0B69D457420979985892CA9D17DEFFDF5A5650008741B369BF02D7386B4365F849F2B38EA99D926C9027F7FAD639B42B359B8EFE19772FBB395A659A7BFEF70FD"

; Сертификаты
Local $sPassCerts = "BFFE59BE546EBAF58E67D2C504D06926F5368F3F916F7FEDD23C8AD87F68A0BAF54D948671CC04F8451452505EC8AB2F8A172824128CB8F20553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0B8520C31CC0E190A152C75CE39BB11F746C3D"
Local $sPassCerts_0 = "BFFE59BE546EBAF58E67D2C504D01752F5368F3F916F7FEDD23C8AD87F68A0BAF54D948671CC04F84514522E5ECBAB2F8A172824128CB8F20553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0BFB54C31CC0E190A152C75CE39BB11F746C3D"
Local $sPassCerts_1 = "BFFE59BE546EBAF68E60D2B004D31756F5368F38916F7EE8D23C8AD87F68A0BBF54D948671CC0486451452505EC8AB2E8A172824128CB8F20553D16857DE9BFC54DFFC4A76B52CBBFB96AC114B0B8525C31CC0E190A152C75CE39BCB1F746C3E"
Local $sPassCerts_2 = "BFFE59BE546EBAF58E67D2C504D01752F5368F3F916F7FEDD23C8AD87F68A0BAF54D948671CC04F8451452505EC8AB2F8A172824128CB8F20553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0B8520C31CC0E190A152C75CE39BB11F746C3D"

; Поиск пропущенных в РНД
Local $sPassMissedRND = "BFFE59BE546EBAF58E67D2C504D06926F5368F38916F7EE8D23C8ADB7F68A7B8F54D948671CC04F8451452505EC8AB558A172824128CB8880553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0B8520C31CC0E190A155B25CE39BB11F746B4D"
Local $sPassMissedRND_0 = "BFFE59BE546EBAF58E67D2C504D01752F5368F38916F7EE8D23C8ADB7F68A7B8F54D948671CC04F84514522E5ECBAB558A172824128CB8880553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0BFB54C31CC0E190A155B25CE39BB11F746B4D"
Local $sPassMissedRND_1 = "BFFE59BE546EBAF58E67D2C504D01752F5368F38916F7EE8D23C8ADB7F68A7B8F54D948671CC04F8451452505EC8AB558A172824128CB8880553D16857DE9BFB54DFFC4A76B252BCFB96AC114B0B8520C31CC0E190A155B25CE39BB11F746B4D"
Local $sPassMissedRND_2 = "BFFE59BE546EBAF58E60D2B004D01751F5368F38916F7EE8D23C8ADB7866A0BCF54D948671CC0486451452505EC8AB2F8A172824128CB8880553D16857DE9BFC54DFFC4A76B52CBBFB96AC114B0B8525C31CC0E190A155B25CE39BB11F746B4D"
Local $sPassMissedRND_3 = "BFFE59BE546EBAF68E67D2C504D06925F5368F38916F7EE8D23C8ADB7866A0BCF54D948671CC04864514522E5ECBAB2F8A172824128CB8880553D16857DE9BFC54DFFC4A76B52CBBFB96AC114B0BFB55C31CC0E190A155B25CE39BB11F746B4D"

; ФНС
Local $sPassFNS = "BFFE59BE546EBAF58E67D2C504D06925F5368F3F916F7FEDD23C8ADB7866A0B8F54D948671CC04F8451452505EC8AB558A172824128CB8880553D16857DE9BF954DFFC4A76B252BCFB96AC114B0B8520C31CC0E190A155B25CE39BB11F746B4DD2050627C6EE6A2D8ED6C6B1A2D006A2393B597F1C44118965CFEA21DE0FD9A0B69D457420979985892CA9D67DEFFDF0A5650008741B369BF02D7386B43658F4"
Local $sPassFNS_0 = "BFFE59BE546EBAF58E67D2C504D01751F5368F3F916F7FEDD23C8ADB7866A0B8F54D948671CC04F84514522E5ECBAB558A172824128CB8880553D16857DE9BF954DFFC4A76B252BCFB96AC114B0BFB54C31CC0E190A155B25CE39BB11F746B4DD2050627C6EE6A2D8ED6C6B0A2D006A9393B597F1C44118965CFEA21DE0FD9A0B1E8400A20969982892CA9D67A9EFDF0A5650008741B369BF02D7386B43658F4"
Local $sPassFNS_1 = "BFFE59BE546EBAF58E60D2B004D06926F5368F38916F7EE8D23C8AD87F68A0BBF54D948671CC0486451452505EC8AB2F8A172824128CB8F20553D16857DE9BFC54DFFC4A76B52CBBFB96AC114B0B8525C31CC0E190A152C75CE39BB11F746B4ED2050627C6EE6A2D8ED6C6B1A2D078A0393B5E081C44118765CFEA5DDE0FA7D2B69D457420979985892CA9D17DEFFDF0A5650008741B369BF02D7387B43658F7"
Local $sPassFNS_2 = "BFFE59BE546EBAF68E67D2C504D01752F5368F38916F7EE8D23C8AD87F68A0BBF54D948671CC04864514522E5ECBAB2F8A172824128CB8F20553D16857DE9BFC54DFFC4A76B52CBBFB96AC114B0BFB55C31CC0E190A152C75CE39BB11F746B4ED2050627C6EE6A2A8ED6C6B1A2D006A2393B5E081C44118765CFEA5DDE0FA7D2B69D457420979985892CA9D67A9EFDF0A5650008741B369BF02D7387B43658F7"


Local $DefaultPassChar = GUICtrlSendMsg($Input_pass, $EM_GETPASSWORDCHAR, 0, 0)
Local $i = 0
Local $err_count = 4 ; Количество неправильных попыток ввода пароля

While 1
	; Автозапуск установки сертификатов
	If $CmdLine[0] > 0 Then
		If $CmdLine[1] = "IDDQD" Then
			TrayItemDelete($idExit)
			GUIDelete($Form_pass)
			$sPass = $sPassCerts
			$Start_param_certs = 1
			ExitLoop
		EndIf
	EndIf

	If $i == $err_count Then
		DirRemove($dir_ecp, 1)
		DirRemove($dir_express, 1)
		DirRemove($dir_federal, 1)
		DirRemove($dir_software, 1)
		DirRemove($dir_certs, 1)
		DirRemove($dir_update, 1)
		DirRemove($dir_logs, 1)
		Exit
	EndIf
    $nMsg = GUIGetMsg()

	If $sPass = _RegSettings("Read") Then ; Реестровые настройки
		TrayItemDelete($idExit)
		GUIDelete($Form_pass)
		ExitLoop
	EndIf

	If _IsPressed("11") And _IsPressed("12") And _IsPressed("6B") Then ; Комбинация заветная
		TrayItemDelete($idExit)
		GUIDelete($Form_pass)
		ExitLoop
	EndIf

    Switch $nMsg
		Case $GUI_EVENT_CLOSE
			GUIDelete($Form_pass)
            Exit

		Case $but_cancel
			GUIDelete($Form_pass)
			Exit

		Case $but_continue
			$i += 1
			$sPass_tmp = GUICtrlRead($Input_pass)
			$sPass_tmp = _StringEncrypt($sPass_tmp)
			If $sPass_tmp = $sPass Or $sPass_tmp = $sPass_0 Or $sPass_tmp = $sPass_1 Or $sPass_tmp = $sPass_2 Or $sPass_tmp = $sPass_3 Then
				TrayItemDelete($idExit)
				GUIDelete($Form_pass)
				ExitLoop
			ElseIf $sPass_tmp = $sPassCerts Or $sPass_tmp = $sPassCerts_0 Or $sPass_tmp = $sPassCerts_1 Or $sPass_tmp = $sPassCerts_2 Then
				TrayItemDelete($idExit)
				GUIDelete($Form_pass)
				$sPass = $sPassCerts
				$Start_param_certs = 1
				ExitLoop
			ElseIf $sPass_tmp = $sPassMissedRND Or $sPass_tmp = $sPassMissedRND_0 Or $sPass_tmp = $sPassMissedRND_1 Or $sPass_tmp = $sPassMissedRND_2 Or $sPass_tmp = $sPassMissedRND_3 Then
				TrayItemDelete($idExit)
				GUIDelete($Form_pass)
				$sPass = $sPassMissedRND
				$Start_param_MissedRND = 1
				ExitLoop
			ElseIf $sPass_tmp = $sPassFNS Or $sPass_tmp = $sPassFNS_0 Or $sPass_tmp = $sPassFNS_1 Or $sPass_tmp = $sPassFNS_2 Then
				TrayItemDelete($idExit)
				GUIDelete($Form_pass)
				$sPass = $sPassFNS
				$Start_param_FNS = 1
				ExitLoop
			Else

				Switch $i
					Case 3
						$try_count = " попытка"
					Case 4
						$try_count = " попыток"
					Case Else
						$try_count = " попытки"
				EndSwitch

				$hErr = MsgBox(0,"Неверный пароль", "Вы неверно ввели пароль. У вас осталось " & $err_count - $i & $try_count)
				WinActivate($hErr)
			EndIf

        Case $check_show_pass
            If (GUICtrlRead($check_show_pass) = $GUI_CHECKED) Then
                GUICtrlSendMsg($Input_pass, $EM_SETPASSWORDCHAR, 0, 0)
            Else
                GUICtrlSendMsg($Input_pass, $EM_SETPASSWORDCHAR, $DefaultPassChar, 0)
            EndIf
            GUICtrlSetState($Input_pass, $GUI_FOCUS)
	EndSwitch

	Switch TrayGetMsg()
		Case $idExit ; выход
			Exit
	EndSwitch
WEnd